@using Web.Helpers
@using Web.Models
@model IEnumerable<Web.Models.StudentViewModel>

@{
    ViewData["Title"] = "Alumnes";
    
    // Obtenir llista d'escoles per al dropdown
    var schools = ViewBag.Schools as IEnumerable<Web.Models.SchoolViewModel> ?? new List<Web.Models.SchoolViewModel>();
    var schoolOptions = schools.Select(s => new Web.Models.SelectOption 
    { 
        Value = s.Id.ToString(), 
        Text = s.Name 
    }).ToList();
    
    var modalConfig = ModalConfigFactory.GetStudentModalConfig(schoolOptions);
    
    // Configuraci√≥ de la taula gen√®rica per alumnes
    var tableConfig = new TableViewModel<StudentViewModel>
    {
        Data = Model,
        EntityName = "Alumnes",
        ControllerName = "Students",
        EmptyMessage = "No hi ha alumnes registrats. Crea el primer!",
        Columns = new List<ColumnConfig>
        {
            new ColumnConfig 
            { 
                PropertyName = "FirstName", 
                DisplayName = "Nom",
                IsSortable = true 
            },
            new ColumnConfig 
            { 
                PropertyName = "LastName", 
                DisplayName = "Cognoms",
                IsSortable = true 
            },
            new ColumnConfig 
            { 
                PropertyName = "Email", 
                DisplayName = "Email",
                IsSortable = true,
                CustomRender = (item) => 
                {
                    var student = item as StudentViewModel;
                    return string.IsNullOrEmpty(student?.Email) 
                        ? "<span class=\"text-muted\">-</span>" 
                        : $"<a href=\"mailto:{student.Email}\">{student.Email}</a>";
                }
            },
            new ColumnConfig 
            { 
                PropertyName = "BirthDate", 
                DisplayName = "Data naixement",
                Format = "dd/MM/yyyy",
                IsSortable = true,
                CustomRender = (item) => 
                {
                    var student = item as StudentViewModel;
                    return student?.BirthDate?.ToString("dd/MM/yyyy") ?? "<span class=\"text-muted\">-</span>";
                }
            },
            new ColumnConfig 
            { 
                PropertyName = "SchoolName", 
                DisplayName = "Escola",
                IsSortable = true 
            }
        },
        Actions = new List<TableAction>
        {
            new TableAction 
            { 
                ActionName = "Details", 
                DisplayText = "Detalls",
                CssClass = "btn-info",
                Icon = "üëÅÔ∏è"
            },
            new TableAction 
            { 
                ActionName = "Delete", 
                DisplayText = "Esborrar",
                CssClass = "btn-danger",
                Icon = "üóëÔ∏è",
                RequiresConfirmation = true,
                ConfirmationMessage = "Est√†s segur que vols esborrar aquest alumne?"
            }
        }
    };
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Alumnes</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createStudentModal">
            <i class="bi bi-plus-lg"></i> Nou Alumne
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            @await Component.InvokeAsync("GenericTable", tableConfig)
        </div>
    </div>
</div>

@await Html.PartialAsync("_EntityModal", modalConfig)
}
</script>
}
