@using Web.Helpers
@using Web.Models
@model IEnumerable<Web.Models.EnrollmentViewModel>

@{
    ViewData["Title"] = Localizer["Inscripcions"];
    
    // Obtenir alumnes del ViewBag per al modal
    var students = ViewBag.Students as List<Web.Models.StudentViewModel> ?? new List<Web.Models.StudentViewModel>();
    var schools = ViewBag.Schools as List<Web.Models.SchoolViewModel> ?? new List<Web.Models.SchoolViewModel>();
    var studentOptions = students.Select(s => new Web.Models.SelectOption 
    { 
        Value = s.Id.ToString(), 
        Text = $"{s.FirstName} {s.LastName}" 
    }).ToList();
    var schoolOptions = schools.Select(s => new Web.Models.SelectOption
    {
        Value = s.Id.ToString(),
        Text = s.Name
    }).ToList();
    var modalConfig = ModalConfigFactory.GetEnrollmentModalConfig(studentOptions, schoolOptions);
    
    // Configuraci√≥ de la taula gen√®rica per inscripcions
    var tableConfig = new TableViewModel<EnrollmentViewModel>
    {
        Data = Model,
        EntityName = Localizer["Inscripcions"].Value,
        ControllerName = "Enrollments",
        EmptyMessage = Localizer["No hi ha inscripcions registrades."].Value,
        Columns = new List<ColumnConfig>
        {
            new ColumnConfig 
            { 
                PropertyName = "StudentName", 
                DisplayName = Localizer["Alumne"].Value,
                IsSortable = true
            },
            new ColumnConfig 
            { 
                PropertyName = "CourseName", 
                DisplayName = Localizer["Nom del Curs"].Value,
                IsSortable = true 
            },
            new ColumnConfig 
            { 
                PropertyName = "AcademicYear", 
                DisplayName = Localizer["Curs acad√®mic"].Value,
                IsSortable = true 
            },
            new ColumnConfig 
            { 
                PropertyName = "Status", 
                DisplayName = Localizer["Estat"].Value,
                IsSortable = true,
                CustomRender = (item) => 
                {
                    var enrollment = item as EnrollmentViewModel;
                    var activeText = Localizer["Activa"].Value;
                    var cancelledText = Localizer["Cancel¬∑lada"].Value;
                    var badgeClass = (enrollment?.Status == "Active" || enrollment?.Status == "Activa") ? "success"
                                   : (enrollment?.Status == "Cancelled" || enrollment?.Status == "Cancel¬∑lada") ? "danger"
                                   : "secondary";
                    var statusText = enrollment?.Status == "Active" ? activeText
                        : enrollment?.Status == "Cancelled" ? cancelledText
                        : enrollment?.Status;
                    return $"<span class=\"badge bg-{badgeClass}\">{statusText}</span>";
                }
            },
            new ColumnConfig 
            { 
                PropertyName = "EnrolledAt", 
                DisplayName = Localizer["Data inscripci√≥"].Value,
                Format = "dd/MM/yyyy",
                IsSortable = true 
            }
        },
        Actions = new List<TableAction>
        {
            new TableAction 
            { 
                ActionName = "Details", 
                DisplayText = Localizer["Detalls"].Value,
                CssClass = "btn-info",
                Icon = "üëÅÔ∏è"
            },
            new TableAction 
            { 
                ActionName = "Delete", 
                DisplayText = Localizer["Esborrar"].Value,
                CssClass = "btn-danger",
                Icon = "üóëÔ∏è",
                RequiresConfirmation = true,
                ConfirmationMessage = Localizer["Est√†s segur que vols esborrar aquesta inscripci√≥?"].Value
            }
        }
    };
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>@Localizer["Inscripcions"]</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEnrollmentModal">
            <i class="bi bi-plus-lg"></i> @Localizer["Nova Inscripci√≥"]
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            @await Component.InvokeAsync("GenericTable", tableConfig)
        </div>
    </div>
</div>

@await Html.PartialAsync("_EntityModal", modalConfig)
