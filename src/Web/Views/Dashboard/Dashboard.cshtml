@{
    ViewData["Title"] = "El meu Tauler";
    var user = ViewBag.User as Web.Models.UserViewModel;
    var student = ViewBag.Student as Web.Models.StudentViewModel;
    var enrollments = ViewBag.Enrollments as List<Web.Models.EnrollmentViewModel>;
    var fees = ViewBag.Fees as List<Web.Models.AnnualFeeViewModel>;
}



@section Styles {
    <link rel="stylesheet" href="~/css/user-dashboard.css" />
}

<!-- Hero amb informació de l'usuari -->
<div class="dashboard-hero">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="welcome-section">
                    <h1 class="welcome-title">Benvingut, @user?.FirstName!</h1>
                    <p class="welcome-subtitle">
                        <i class="bi bi-person-badge"></i> @student?.FirstName @student?.LastName
                        <span class="mx-2">|</span>
                        <i class="bi bi-building"></i> @student?.SchoolName
                    </p>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <!-- Botó Sortir eliminat -->
            </div>
        </div>
    </div>
</div>

<div class="container py-5">
    @if (student == null)
    {
        <div class="alert alert-warning text-center p-5">
            <i class="bi bi-exclamation-triangle exclamation-large"></i>
            <h3 class="mt-3">@ViewBag.Message</h3>
        </div>
    }
    else
    {
        <!-- Estadístiques ràpides -->
        <div class="row mb-5">
            <div class="col-md-4">
                <div class="stat-card stat-primary">
                    <div class="stat-icon">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@enrollments?.Count</h3>
                        <p class="stat-label">Inscripcions Actives</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card stat-success">
                    <div class="stat-icon">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@fees?.Count(f => f.PaidAt.HasValue)</h3>
                        <p class="stat-label">Quotes Pagades</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card stat-warning">
                    <div class="stat-icon">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@fees?.Count(f => !f.PaidAt.HasValue)</h3>
                        <p class="stat-label">Quotes Pendents</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Les meves inscripcions -->
        <div class="section-card mb-5">
            <div class="section-header">
                <h2><i class="bi bi-journal-bookmark"></i> Les meves inscripcions</h2>
            </div>
            <div class="section-body">
                @if (enrollments == null || !enrollments.Any())
                {
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p>No tens cap inscripció activa</p>
                    </div>
                }
                else
                {
                    <div class="row">
                        @foreach (var enrollment in enrollments)
                        {
                            <div class="col-md-6 mb-4">
                                <div class="enrollment-card">
                                    <div class="enrollment-header">
                                        <h4>@(enrollment.CourseName ?? "Sense curs") - @(enrollment.SchoolName ?? "Sense escola")</h4>
                                        <span class="badge badge-@(enrollment.Status == "Active" ? "success" : "secondary")">
                                            @enrollment.Status
                                        </span>
                                    </div>
                                    <div class="enrollment-body">
                                        <p><i class="bi bi-building"></i> <strong>Escola:</strong> @enrollment.SchoolName ?? "-"</p>
                                        <p><i class="bi bi-calendar3"></i> <strong>Any acadèmic:</strong> @(enrollment.AcademicYear ?? "?")</p>
                                        <p><i class="bi bi-clock-history"></i> <strong>Data inscripció:</strong> @(enrollment.EnrolledAt is DateTime dt ? dt.ToString("dd/MM/yyyy") : "?")</p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Les meves quotes -->
        <div class="section-card">
            <div class="section-header">
                <h2><i class="bi bi-credit-card"></i> Les meves quotes</h2>
            </div>
            <div class="section-body">
                @if (fees == null || !fees.Any())
                {
                    <div class="empty-state">
                        <i class="bi bi-wallet2"></i>
                        <p>No tens cap quota associada</p>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="fees-table">
                            <thead>
                                <tr>
                                    <th>Import</th>
                                    <th>Venciment</th>
                                    <th>Estat</th>
                                    <th>Data Pagament</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var fee in fees.OrderBy(f => f.DueDate))
                                {
                                    <tr class="@(fee.PaidAt != null ? "paid" : "pending")">                                        
                                        <td class="amount">@fee.Amount.ToString("N2") @fee.Currency</td>
                                        <td>@fee.DueDate.ToString("dd/MM/yyyy")</td>
                                        <td>
                                            @if (fee.PaidAt != null)
                                            {
                                                <span class="status-badge status-paid">
                                                    <i class="bi bi-check-circle"></i> Pagada
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="status-badge status-pending">
                                                    <i class="bi bi-clock"></i> Pendent
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            @if (fee.PaidAt != null)
                                            {
                                                @((fee.PaidAt as DateTime?)?.ToString("dd/MM/yyyy"))
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    }
</div>
