@using Web.Helpers
@using Web.Models
@model IEnumerable<Web.Models.SchoolViewModel>

@{
    ViewData["Title"] = Localizer["Escoles"];
    
    // Obtenir scopes del ViewBag per al modal
    var scopeOptions = ViewBag.Scopes as List<Web.Models.SelectOption> ?? new List<Web.Models.SelectOption>();
    var modalConfig = ModalConfigFactory.GetSchoolModalConfig(scopeOptions);
    
    // Configuraci√≥ de la taula gen√®rica
    var tableConfig = new TableViewModel<SchoolViewModel>
    {
        Data = Model,
        EntityName = Localizer["Escoles"].Value,
        ControllerName = "Schools",
        EmptyMessage = Localizer["No hi ha escoles registrades. Crea la primera!"].Value,
        Columns = new List<ColumnConfig>
        {
            new ColumnConfig 
            { 
                PropertyName = "Code", 
                DisplayName = Localizer["Codi"].Value,
                IsSortable = true 
            },
            new ColumnConfig 
            { 
                PropertyName = "Name", 
                DisplayName = Localizer["Nom"].Value,
                IsSortable = true 
            },
            new ColumnConfig 
            { 
                PropertyName = "City", 
                DisplayName = Localizer["Ciutat"].Value,
                IsSortable = true 
            },
            new ColumnConfig 
            { 
                PropertyName = "ScopeName", 
                DisplayName = Localizer["√Ämbit"].Value,
                IsSortable = true,
                CustomRender = (item) => 
                {
                    var school = item as SchoolViewModel;
                    if (!string.IsNullOrEmpty(school?.ScopeName))
                        return $"<span class=\"badge bg-info\">{school.ScopeName}</span>";
                    return "<span class=\"text-muted\">-</span>";
                }
            },
            new ColumnConfig 
            { 
                PropertyName = "IsFavorite", 
                DisplayName = Localizer["Favorit"].Value,
                IsSortable = true,
                CustomRender = (item) => 
                {
                    var school = item as SchoolViewModel;
                    if (school?.IsFavorite == true)
                        return $"<span class=\"star-icon star-filled\" title=\"{Localizer["Escola favorita"].Value}\">‚òÖ</span>";
                    return $"<span class=\"star-icon star-outline\" title=\"{Localizer["No √©s favorita"].Value}\">‚òÜ</span>";
                }
            },
            new ColumnConfig 
            { 
                PropertyName = "CreatedAt", 
                DisplayName = Localizer["Data creaci√≥"].Value,
                Format = "dd/MM/yyyy",
                IsSortable = true 
            }
        },
        Actions = new List<TableAction>
        {
            new TableAction 
            { 
                ActionName = "Details", 
                DisplayText = Localizer["Detalls"].Value,
                CssClass = "btn-info",
                Icon = "üëÅÔ∏è"
            },
            new TableAction 
            { 
                ActionName = "Delete", 
                DisplayText = Localizer["Esborrar"].Value,
                CssClass = "btn-danger",
                Icon = "üóëÔ∏è",
                RequiresConfirmation = true,
                ConfirmationMessage = Localizer["Est√†s segur que vols esborrar aquesta escola?"].Value
            }
        }
    };
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>@Localizer["Escoles"]</h2>
        @if ((ViewBag.UserRole as string) == "ADM")
        {
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createSchoolModal">
                <i class="bi bi-plus-lg"></i> @Localizer["Nova Escola"]
            </button>
        }
    </div>

    <div class="card">
        <div class="card-body" id="schoolsTableContainer">
            @await Component.InvokeAsync("GenericTable", tableConfig)
        </div>
    </div>
</div>

@await Html.PartialAsync("_EntityModal", modalConfig)
