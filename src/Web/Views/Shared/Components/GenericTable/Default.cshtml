@using System.Reflection
@model dynamic

@{
    // Obtenir el tipus genèric del model
    var modelType = Model.GetType();
    var dataProperty = modelType.GetProperty("Data");
    var data = dataProperty?.GetValue(Model) as IEnumerable<object> ?? Enumerable.Empty<object>();
    
    var columns = (List<Web.Models.ColumnConfig>)Model.Columns;
    var actions = (List<Web.Models.TableAction>)Model.Actions;
    var entityName = (string)Model.EntityName;
    var controllerName = (string)Model.ControllerName;
    var hasSearch = (bool)Model.HasSearch;
    var emptyMessage = (string)Model.EmptyMessage;
    var idPropertyName = (string)Model.IdPropertyName;
    var customCssClass = (string)Model.CustomCssClass;
    
    var dataList = data.ToList();
    var hasData = dataList.Any();
}

<div class="table-container">
    @if (hasSearch)
    {
        <div class="mb-3">
            <input type="text" 
                   class="form-control" 
                   id="tableSearch" 
                   placeholder="Cercar a @entityName..." 
                   onkeyup="filterTable(this)">
        </div>
    }

    @if (!hasData)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> @emptyMessage
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover @customCssClass" id="genericTable">
                <thead class="table-dark">
                    <tr>
                        @foreach (var column in columns.Where(c => !c.IsActionColumn))
                        {
                            <th class="@(column.IsSortable ? "sortable" : "")" 
                                @(column.IsSortable ? "onclick=sortTable(this)" : "")
                                data-column="@column.PropertyName">
                                @column.DisplayName
                                @if (column.IsSortable)
                                {
                                    <span class="sort-icon">⇅</span>
                                }
                            </th>
                        }
                        @if (actions.Any())
                        {
                            <th class="text-center" style="min-width: 150px;">Accions</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in dataList)
                    {
                        var itemType = item.GetType();
                        var idProperty = itemType.GetProperty(idPropertyName);
                        var idValue = idProperty?.GetValue(item);

                        <tr>
                            @foreach (var column in columns.Where(c => !c.IsActionColumn))
                            {
                                var property = itemType.GetProperty(column.PropertyName);
                                var value = property?.GetValue(item);
                                
                                string displayValue;
                                
                                if (column.CustomRender != null)
                                {
                                    displayValue = column.CustomRender(item);
                                }
                                else if (value == null)
                                {
                                    displayValue = "-";
                                }
                                else if (!string.IsNullOrEmpty(column.Format))
                                {
                                    // Format per dates, moneda, etc.
                                    if (value is DateTime dateValue)
                                    {
                                        displayValue = dateValue.ToString(column.Format);
                                    }
                                    else if (value is decimal decimalValue)
                                    {
                                        displayValue = decimalValue.ToString(column.Format);
                                    }
                                    else
                                    {
                                        displayValue = value.ToString() ?? "-";
                                    }
                                }
                                else if (value is bool boolValue)
                                {
                                    displayValue = boolValue ? "✓" : "✗";
                                }
                                else if (value is DateTime dateTimeValue)
                                {
                                    displayValue = dateTimeValue.ToString("dd/MM/yyyy HH:mm");
                                }
                                else if (value is DateOnly dateOnlyValue)
                                {
                                    displayValue = dateOnlyValue.ToString("dd/MM/yyyy");
                                }
                                else
                                {
                                    displayValue = value.ToString() ?? "-";
                                }

                                <td data-label="@column.DisplayName">@Html.Raw(displayValue)</td>
                            }

                            @if (actions.Any())
                            {
                                <td class="text-center" data-label="Accions">
                                    <div class="d-flex justify-content-center" style="gap: 2px;">
                                        @foreach (var action in actions)
                                        {
                                            var targetController = string.IsNullOrEmpty(action.Controller) ? controllerName : action.Controller;
                                            
                                            if (action.RequiresConfirmation)
                                            {
                                                <form method="post" 
                                                      asp-controller="@targetController" 
                                                      asp-action="@action.ActionName" 
                                                      asp-route-id="@idValue"
                                                      onsubmit="return confirm('@(action.ConfirmationMessage ?? "Estàs segur?")' )"
                                                      style="display:inline;">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-sm @action.CssClass">
                                                        @if (!string.IsNullOrEmpty(action.Icon))
                                                        {
                                                            <span>@action.Icon</span>
                                                        }
                                                        @action.DisplayText
                                                    </button>
                                                </form>
                                            }
                                            else
                                            {
                                                <a asp-controller="@targetController" 
                                                   asp-action="@action.ActionName" 
                                                   asp-route-id="@idValue" 
                                                   class="btn btn-sm @action.CssClass">
                                                    @if (!string.IsNullOrEmpty(action.Icon))
                                                    {
                                                        <span>@action.Icon</span>
                                                    }
                                                    @action.DisplayText
                                                </a>
                                            }
                                        }
                                    </div>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<style>
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
    }
    
    .sortable:hover {
        background-color: rgba(255,255,255,0.1);
    }
    
    .sort-icon {
        margin-left: 5px;
        opacity: 0.5;
        font-size: 0.8em;
    }
    
    .sortable.sorted-asc .sort-icon::after {
        content: ' ↑';
        opacity: 1;
    }
    
    .sortable.sorted-desc .sort-icon::after {
        content: ' ↓';
        opacity: 1;
    }
    
    /* Responsive - Mobile */
    @@media (max-width: 767.98px) {
        .table thead {
            display: none;
        }
        
        .table tbody tr {
            display: block;
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
        }
        
        .table tbody td {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border: none;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .table tbody td:before {
            content: attr(data-label);
            font-weight: 600;
            margin-right: 1rem;
            color: #666;
        }
        
        .table tbody td:last-child {
            border-bottom: none;
        }
        
        /* Responsive actions - vertical amb separació */
        td[data-label="Accions"] > div {
            display: flex !important;
            flex-direction: column !important;
            gap: 5px !important;
            width: 100%;
        }
        
        td[data-label="Accions"] .btn {
            width: 100%;
        }
    }
</style>

<script>
    // Cerca a la taula
    function filterTable(input) {
        const filter = input.value.toLowerCase();
        const table = document.getElementById('genericTable');
        const rows = table.getElementsByTagName('tr');
        
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const text = row.textContent || row.innerText;
            
            if (text.toLowerCase().indexOf(filter) > -1) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    }
    
    // Ordenació de columnes
    function sortTable(header) {
        const table = document.getElementById('genericTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        const rows = Array.from(tbody.getElementsByTagName('tr'));
        const columnIndex = Array.from(header.parentElement.children).indexOf(header);
        
        // Determinar direcció d'ordenació
        const isAscending = !header.classList.contains('sorted-asc');
        
        // Treure classes d'altres columnes
        const headers = header.parentElement.getElementsByTagName('th');
        for (let h of headers) {
            h.classList.remove('sorted-asc', 'sorted-desc');
        }
        
        // Afegir classe a la columna actual
        header.classList.add(isAscending ? 'sorted-asc' : 'sorted-desc');
        
        // Ordenar files
        rows.sort((a, b) => {
            const cellA = a.getElementsByTagName('td')[columnIndex].textContent.trim();
            const cellB = b.getElementsByTagName('td')[columnIndex].textContent.trim();
            
            // Comprovar si són números
            const numA = parseFloat(cellA.replace(/[^\d.-]/g, ''));
            const numB = parseFloat(cellB.replace(/[^\d.-]/g, ''));
            
            if (!isNaN(numA) && !isNaN(numB)) {
                return isAscending ? numA - numB : numB - numA;
            }
            
            // Comparació de text
            return isAscending 
                ? cellA.localeCompare(cellB, 'ca')
                : cellB.localeCompare(cellA, 'ca');
        });
        
        // Reordenar al DOM
        rows.forEach(row => tbody.appendChild(row));
    }
</script>
