@using System.Reflection
@model dynamic

@{
    // Obtenir el tipus genèric del model
    var modelType = Model.GetType();
    var dataProperty = modelType.GetProperty("Data");
    var data = dataProperty?.GetValue(Model) as IEnumerable<object> ?? Enumerable.Empty<object>();
    
    var columns = (List<Web.Models.ColumnConfig>)Model.Columns;
    var actions = (List<Web.Models.TableAction>)Model.Actions;
    var entityName = (string)Model.EntityName;
    var controllerName = (string)Model.ControllerName;
    var hasSearch = (bool)Model.HasSearch;
    var emptyMessage = (string)Model.EmptyMessage;
    var idPropertyName = (string)Model.IdPropertyName;
    var customCssClass = (string)Model.CustomCssClass;
    
    var dataList = data.ToList();
    var hasData = dataList.Any();
}

<div class="table-container">
    @if (hasSearch)
    {
        <div class="mb-3">
            <input type="text" 
                   class="form-control" 
                   id="tableSearch" 
                   placeholder="Cercar a @entityName..." 
                   onkeyup="filterTable(this)">
        </div>
    }

    @if (!hasData)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> @emptyMessage
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover @customCssClass" id="genericTable">
                <thead class="table-dark">
                    <tr>
                        @foreach (var column in columns.Where(c => !c.IsActionColumn))
                        {
                            <th class="@(column.IsSortable ? "sortable" : "")" 
                                @(column.IsSortable ? "onclick=sortTable(this)" : "")
                                data-column="@column.PropertyName">
                                @column.DisplayName
                                @if (column.IsSortable)
                                {
                                    <span class="sort-icon">⇅</span>
                                }
                            </th>
                        }
                        @if (actions.Any())
                        {
                            <th class="text-center actions-column">Accions</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in dataList)
                    {
                        var itemType = item.GetType();
                        var idProperty = itemType.GetProperty(idPropertyName);
                        var idValue = idProperty?.GetValue(item);

                        <tr>
                            @foreach (var column in columns.Where(c => !c.IsActionColumn))
                            {
                                var property = itemType.GetProperty(column.PropertyName);
                                var value = property?.GetValue(item);
                                
                                string displayValue;
                                
                                if (column.CustomRender != null)
                                {
                                    displayValue = column.CustomRender(item);
                                }
                                else if (value == null)
                                {
                                    displayValue = "-";
                                }
                                else if (!string.IsNullOrEmpty(column.Format))
                                {
                                    // Format per dates, moneda, etc.
                                    if (value is DateTime dateValue)
                                    {
                                        displayValue = dateValue.ToString(column.Format);
                                    }
                                    else if (value is decimal decimalValue)
                                    {
                                        displayValue = decimalValue.ToString(column.Format);
                                    }
                                    else
                                    {
                                        displayValue = value.ToString() ?? "-";
                                    }
                                }
                                else if (value is bool boolValue)
                                {
                                    displayValue = boolValue ? "✓" : "✗";
                                }
                                else if (value is DateTime dateTimeValue)
                                {
                                    displayValue = dateTimeValue.ToString("dd/MM/yyyy HH:mm");
                                }
                                else if (value is DateOnly dateOnlyValue)
                                {
                                    displayValue = dateOnlyValue.ToString("dd/MM/yyyy");
                                }
                                else
                                {
                                    displayValue = value.ToString() ?? "-";
                                }

                                <td data-label="@column.DisplayName">@Html.Raw(displayValue)</td>
                            }

                            @if (actions.Any())
                            {
                                <td class="text-center" data-label="Accions">
                                    <div class="d-flex justify-content-center actions-buttons">
                                        @foreach (var action in actions)
                                        {
                                            var targetController = string.IsNullOrEmpty(action.Controller) ? controllerName : action.Controller;
                                            
                                            if (action.RequiresConfirmation)
                                            {
                                                <form method="post" 
                                                      asp-controller="@targetController" 
                                                      asp-action="@action.ActionName" 
                                                      asp-route-id="@idValue"
                                                      onsubmit="return confirm('@(action.ConfirmationMessage ?? "Estàs segur?")' )"
                                                      class="delete-form">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-sm @action.CssClass">
                                                        @if (!string.IsNullOrEmpty(action.Icon))
                                                        {
                                                            <span>@action.Icon</span>
                                                        }
                                                        @action.DisplayText
                                                    </button>
                                                </form>
                                            }
                                            else
                                            {
                                                <a asp-controller="@targetController" 
                                                   asp-action="@action.ActionName" 
                                                   asp-route-id="@idValue" 
                                                   class="btn btn-sm @action.CssClass">
                                                    @if (!string.IsNullOrEmpty(action.Icon))
                                                    {
                                                        <span>@action.Icon</span>
                                                    }
                                                    @action.DisplayText
                                                </a>
                                            }
                                        }
                                    </div>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<link rel="stylesheet" href="~/css/generic-table.css" />
<script src="~/js/generic-table.js"></script>
